---
title: "Module - Batch Correction"
author: "BTC Pipeline"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
    self_contained: true
params:
  project_name: 'Test'
  project_object: './dev/data/ovarian_tme_cluster_multiple_batch.RDS'
  input_target_variables: 'batch'
  input_batch_method: 'all'
  thr_cell_proportion: 0.25
  thr_npc: 'auto'
  workdir: !r here::here()
  timestamp: !r Sys.Date()
  auto_save: !r TRUE
---

------------------------------------------------------------------------

# Project Name: `r params$project_name`

```{r setup, include = FALSE, message = FALSE, warning = FALSE, echo = FALSE}

# Project parameters 
project_name <- params$project_name
project_object <- params$project_object

# Filter and thresholds
input_batch_method <- params$input_batch_method
input_target_variables <- strsplit(
  params$input_target_variables, split = ';')[[1]]

# Optional parameters

# Dataflow/Computational parameters
thr_cell_proportion <- params$thr_cell_proportion
thr_npc <- params$thr_npc

# Output parameters
work_directory <- params$workdir
timestamp <- params$timestamp
auto_save <- params$auto_save

# Rmarkdown options
knitr::opts_chunk$set(
  echo = TRUE,
  error = TRUE,
  message = FALSE, 
  warning = FALSE,
  fig.height = 8, 
  fig.width = 12,
  fig.align = 'center'
  )

knitr::opts_knit$set(
  root.dir = work_directory
  )

```

## Loading library

```{r library}

library(readr)
library(dplyr)
library(ggplot2)
library(Seurat)
library(SeuratWrappers)
library(harmony)
library(kBET)

```

## Folder structure

```{r project_directory}

if(!dir.exists(work_directory)) {
  dir.create(work_directory, recursive = T)
}

for(sub_directory in c('figures', 'figures/batch')) {
  dir.create(paste0(work_directory, '/', sub_directory))
}

```

```{r loading_rds}

# Reading seurat object
seurat_object <- readRDS(file = project_object)

# Setting random seed
random_seed <- 2203
set.seed(random_seed)


```

```{r basic_input_validation}

# Cell number
ncell <- dim(seurat_object)[2]

# Knowledge-based parameters
if(thr_npc == 'auto') {
  thr_npc <- ifelse(ncell < 50000, 25, 50)
}

# Checking variables and metadata columns
meta_columns <- colnames(seurat_object@meta.data)
input_target_variables <- intersect(input_target_variables, meta_columns)

# Batch method
boolean_vector <- 
  switch(input_batch_method,
  'all' = c(T, T, T, T), 
  'cca' = c(T, F, F, F),
  'rpca' = c(F, T, F, F),
  'harmony' = c(F, F, T, F),
  'mnn' = c(F, F, F, T)
)

```

```{r cca_integration, eval = boolean_vector[[1]]}

seurat_object <- IntegrateLayers(
  object = seurat_object, 
  method = CCAIntegration,
  orig.reduction = "pca", 
  new.reduction = "integrated.cca",
  verbose = FALSE
)

```

```{r rpca_integration, eval = boolean_vector[[2]]}

seurat_object <- IntegrateLayers(
  object = seurat_object, 
  method = RPCAIntegration,
  orig.reduction = "pca", 
  new.reduction = "integrated.rpca",
  verbose = FALSE
)

```

```{r harmony_integration, eval = boolean_vector[[3]]}

seurat_object <- IntegrateLayers(
  object = seurat_object, 
  method = HarmonyIntegration,
  orig.reduction = "pca", 
  new.reduction = "intergrated.harmony",
  verbose = FALSE
)

```

```{r fastmnn_integration, eval = boolean_vector[[4]]}

seurat_object <- IntegrateLayers(
  object = seurat_object, 
  method = FastMNNIntegration,
  new.reduction = "integrated.mnn",
  verbose = FALSE
)

```

## Saving Seurat object

```{r object_dump}

if(auto_save) {
  
  saveRDS(seurat_object, file = paste0(project_name, '_batch_object_', timestamp, '.RDS'))
  
}

```

------------------------------------------------------------------------

## Parameters log

```{r params_log, message = FALSE, warning = FALSE, echo = FALSE}

print(params)

```

## Session info

```{r session_info, message = FALSE, warning = FALSE, echo = FALSE}

sessionInfo()

```
